import{registerComponents as t}from"../../common/register-components.js";import{GlGoogleMarker as e}from"../gl-google-marker/gl-google-marker.js";class GlGoogleMap extends HTMLElement{static get observedAttributes(){return["key","latitude","longitude","overlay","map-style","show-markers","show-kml","show-image"]}static async getStyle(t){const e=await fetch(t);return await e.json()}constructor(){super();const i=document.createElement("template");i.innerHTML='<style>.lot__content,.lot__image{background:rgb(255 255 255 / .85);backdrop-filter:brightness(140%) blur(10px)}.lot__content h3 span,.lot__cta{font-weight:300;text-transform:uppercase;color:#fff}:host{position:relative;display:block;width:100%;min-height:400px}:host .gl-map{display:flex;position:absolute;top:0;left:0;width:100%;height:100%;border-radius:4px;overflow:hidden}:host .gl-map__detail,:host .gl-map__map{position:absolute;top:0;height:100%}:host .gl-map__map{left:0;width:100%}:host .gl-map__detail{right:0;width:0;overflow:hidden;box-sizing:border-box;transition:width .2s ease-out;will-change:width}:host .gl-map__detail::after{content:\'\';position:absolute;top:0;left:0;width:100%;mix-blend-mode:multiply}:host .gl-map.has-detail .gl-map__detail{width:50%}:host .gl-map__detail-close{cursor:pointer;position:absolute;display:flex;align-items:center;justify-content:center;top:9px;right:9px;width:30px;height:30px;margin:0;padding:0;font-size:30px;font-weight:300;color:#666;border:0;border-radius:4px;background:rgb(255 255 255 / .85);backdrop-filter:brightness(140%) blur(10px);transition:color .2s ease-out,background .2s ease-out}.lot,.lot__image{position:relative}:host .gl-map__detail-close:focus,:host .gl-map__detail-close:hover{color:#333;background:#fff}:host .gl-map__detail-content{position:relative;top:3px;width:calc(100% - 3px);height:calc(100% - 6px);overflow:auto;box-sizing:border-box}.lot{display:grid;grid-template-rows:max-content 1fr;height:100%}.lot__image{width:100%;height:0;margin-bottom:3px;padding-top:calc(100% * (9 / 16));border-radius:0 4px 0 0}.lot__cta,.lot__img{width:calc(100% - 6px)}.lot__img{position:absolute;display:block;top:3px;left:3px;height:calc(100% - 6px);object-fit:cover;object-position:center;border-radius:2px 4px 2px 2px}.lot__content{position:relative;padding:17px;border-radius:0 0 4px}.lot__content h3{display:grid;grid-auto-flow:column;grid-auto-columns:max-content;gap:3px;margin:0 0 10px}.lot__content h3 span{display:inline-block;margin:0;padding:.25em .75em;font-size:12px;border-radius:2px;background:#333}.lot__content h3 .sold{background:#600}.lot__content h3 .model,.lot__cta{background:#1649c8}.lot__content h3 .pending{background:#9d7f09}.lot__content p{margin:0;font-size:16px}.lot__snapshot{display:grid;grid-template-columns:repeat(3,max-content);gap:.75em;margin:10px 0;line-height:1}.lot__snapshot div:not(:first-child){padding-left:.75em;border-left:1px solid #666}.lot__cta{position:absolute;display:flex;align-items:center;justify-content:center;height:40px;right:3px;bottom:3px;padding:0 17px;font-size:14px;text-decoration:none;border-radius:2px 2px 4px;box-sizing:border-box;transition:background .2s ease-out}.lot__cta:focus,.lot__cta:hover{background:#142755}</style><div class="gl gl-map"><div class="gl-map__map"></div></div>',this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(i.content.cloneNode(!0)),t(e),this.isAdmin=!0,this.key="",this._id=crypto.randomUUID?crypto.randomUUID().split("-").pop():Math.round(9999*Math.random()),this._imageElem=this.querySelector("img"),this._markerElems=[...this.querySelectorAll("gl-google-marker")],this._markers=[],this._adminMarkers=[],this.apiLoadedCBName=`gl_cb_${this._id}`,this.map=void 0,this.styleLayer=void 0,this.imageLayer=void 0,this.imageNE=0,this.imageNW=0,this.imageSW=0,this.imageSE=0,this.kmlLayer=void 0,this.elem=this.shadowRoot.querySelector(".gl-map"),this.mapElem=this.shadowRoot.querySelector(".gl-map__map"),this.detailElem=null,this.elem.setAttribute("id",`map_${this._id}`),this.generateAdminMarker=this.generateAdminMarker.bind(this),this.generateMarker=this.generateMarker.bind(this),this.loadDetail=this.loadDetail.bind(this)}get isMarkersVisible(){return"true"===this.getAttribute("show-markers")}set isMarkersVisible(t){this.setAttribute("show-markers",t)}get isKmlVisible(){return"true"===this.getAttribute("show-kml")}set isKmlVisible(t){this.setAttribute("show-kml",t)}get isImageVisible(){return"true"===this.getAttribute("show-image")}set isImageVisible(t){this.setAttribute("show-image",t)}get latitude(){const t=parseFloat(this.hasAttribute("latitude")?this.getAttribute("latitude"):"0");return isNaN(t)?0:t}get longitude(){const t=parseFloat(this.hasAttribute("longitude")?this.getAttribute("longitude"):"0");return isNaN(t)?0:t}get overlay(){return this.getAttribute("overlay")}get mapStyle(){return this.getAttribute("map-style")}get markerElems(){return[...this._markerElems]}get imageElemPosition(){const t=parseFloat(this._imageElem.getAttribute("latitude-ne")),e=parseFloat(this._imageElem.getAttribute("longitude-ne")),i=parseFloat(this._imageElem.getAttribute("latitude-sw")),s=parseFloat(this._imageElem.getAttribute("longitude-sw"));return{neLatitude:isNaN(t)?0:t,neLongitude:isNaN(e)?0:e,swLatitude:isNaN(i)?0:i,swLongitude:isNaN(s)?0:s}}set imageElemPosition(t){if(this._imageElem.setAttribute("latitude-ne",t.neLatitude),this._imageElem.setAttribute("longitude-ne",t.neLongitude),this._imageElem.setAttribute("latitude-sw",t.swLatitude),this._imageElem.setAttribute("longitude-sw",t.swLongitude),google&&google.maps&&this.imageLayer){const e=new google.maps.LatLngBounds(new google.maps.LatLng(t.neLatitude,t.neLongitude),new google.maps.LatLng(t.swLatitude,t.swLongitude));this.imageLayer.setBounds(e),this.imageLayer.draw()}}get adminMarkers(){return this._adminMarkers}set adminMarkers(t){this._adminMarkers=Array.isArray(t)?t.map(this.generateAdminMarker):[]}get markers(){return this._markers}set markers(t){this.map&&google&&google.maps?this._markers=[...this.adminMarkers,...t.map(this.generateMarker)]:this._markers=[...this.adminMarkers]}handleApiLoaded(){this.map=new google.maps.Map(this.mapElem,{center:{lat:this.latitude,lng:this.longitude},mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,fullscreenControl:!1,zoom:8}),this.setMapStyle(),this.placeImages(),this.generateKml(),this.markers=this.markerElems}async placeImages(){const t=this._imageElem.getAttribute("src"),e=this.imageElemPosition.neLatitude,i=this.imageElemPosition.neLongitude,s=this.imageElemPosition.swLatitude,a=this.imageElemPosition.swLongitude,o=new google.maps.LatLngBounds(new google.maps.LatLng(e,i),new google.maps.LatLng(s,a));function l(t,e,i){this._bounds=t,this._imageElem=e,this._map=i,this._div=void 0,this.setMap(i)}this.adminMarkers=[{label:"ne",latitude:e,longitude:i},{label:"sw",latitude:s,longitude:a}],t&&(l.prototype=new google.maps.OverlayView,l.prototype.setBounds=function(t){this._bounds=t},l.prototype.onAdd=function(){const t=this.getPanes();this._div=document.createElement("div"),this._div.style.border="2px solid red",this._div.style.position="absolute",this._imageElem.parentNode.removeChild(this._imageElem),this._imageElem.style.width="100%",this._imageElem.style.height="100%",this._imageElem.style.position="absolute",this._imageElem.style.display="block",this._div.appendChild(this._imageElem),t.overlayLayer.appendChild(this._div)},l.prototype.draw=function(t){const e=this.getProjection(),i=t?t.getNorthEast():this._bounds.getNorthEast(),s=t?t.getSouthWest():this._bounds.getSouthWest(),a=e.fromLatLngToDivPixel(s),o=e.fromLatLngToDivPixel(i);this._div&&(this._div.style.top=`${a.y}px`,this._div.style.left=`${o.x}px`,this._div.style.width=a.x-o.x+"px",this._div.style.height=o.y-a.y+"px")},l.prototype.onRemove=function(){this._div&&(this._div.parentNode.removeChild(this._div),this._div=null)},this.imageLayer=new l(o,this._imageElem,this.map),this.imageLayer.setMap(this.map))}async setMapStyle(){const t=await GlGoogleMap.getStyle(this.mapStyle);t&&(this.styleLayer=new google.maps.StyledMapType(t,{name:`Map${this._id}`}),this.map.mapTypes.set(`map_${this._id}`,this.styleLayer),this.map.setMapTypeId(`map_${this._id}`))}generateKml(){this.kmlLayer=new google.maps.KmlLayer({url:this.overlay,map:this.map,suppressInfoWindows:!0})}generateAdminMarker(t){const e=new google.maps.Marker({map:this.map,type:"admin",position:{lat:t.latitude,lng:t.longitude},icon:{path:"M10 20c5.523 0 10-4.477 10-10S15.523 0 10 0 0 4.477 0 10s4.477 10 10 10Z",scale:1,fillColor:"white",strokeColor:"white",fillOpacity:.8,strokeWeight:2,anchor:new google.maps.Point(10,10)},draggable:!0});return e.addListener("dragstart",(t=>{console.log("drag began",t)})),e.addListener("drag",(e=>{const i=t.label,s=e.latLng.lat(),a=e.latLng.lng();this.imageElemPosition={neLatitude:"nw"===i||"ne"===i?s:this.imageElemPosition.neLatitude,neLongitude:"nw"===i||"ne"===i?a:this.imageElemPosition.neLongitude,swLatitude:"sw"===i||"se"==i?s:this.imageElemPosition.swLatitude,swLongitude:"sw"===i||"se"==i?a:this.imageElemPosition.swLongitude}})),e.addListener("dragend",(t=>{console.log("drag finished",t)})),e}generateMarker(t){const e=new google.maps.Marker({map:this.map,id:t.id,type:"client",position:{lat:t.latitude,lng:t.longitude},icon:{path:"M10 0c5.52285 0 10 4.47715 10 10 0 7.50794-5.59957 12.48988-10 12.48988S0 17.78101 0 10C0 4.47715 4.47715 0 10 0Zm0 3.4743c-3.60404 0-6.5257 2.92166-6.5257 6.5257 0 3.60404 2.92166 6.5257 6.5257 6.5257 3.60404 0 6.5257-2.92166 6.5257-6.5257 0-3.60404-2.92166-6.5257-6.5257-6.5257Zm0 3.0039c1.94504 0 3.5218 1.57676 3.5218 3.5218 0 1.94504-1.57676 3.5218-3.5218 3.5218-1.94504 0-3.5218-1.57676-3.5218-3.5218 0-1.94504 1.57676-3.5218 3.5218-3.5218Z",fillColor:"red",fillOpacity:.6,strokeWeight:0,anchor:new google.maps.Point(10,22)},animation:google.maps.Animation.DROP,draggable:!0});return e.addListener("mouseover",(()=>{e.setIcon({path:"M10 0c5.52285 0 10 4.47715 10 10 0 7.50794-5.59957 12.48988-10 12.48988S0 17.78101 0 10C0 4.47715 4.47715 0 10 0Zm0 3.4743c-3.60404 0-6.5257 2.92166-6.5257 6.5257 0 3.60404 2.92166 6.5257 6.5257 6.5257 3.60404 0 6.5257-2.92166 6.5257-6.5257 0-3.60404-2.92166-6.5257-6.5257-6.5257Zm0 3.0039c1.94504 0 3.5218 1.57676 3.5218 3.5218 0 1.94504-1.57676 3.5218-3.5218 3.5218-1.94504 0-3.5218-1.57676-3.5218-3.5218 0-1.94504 1.57676-3.5218 3.5218-3.5218Z",fillColor:"red",fillOpacity:1,strokeWeight:0,anchor:new google.maps.Point(10,22)})})),e.addListener("mouseout",(()=>{e.setIcon({path:"M10 0c5.52285 0 10 4.47715 10 10 0 7.50794-5.59957 12.48988-10 12.48988S0 17.78101 0 10C0 4.47715 4.47715 0 10 0Zm0 3.4743c-3.60404 0-6.5257 2.92166-6.5257 6.5257 0 3.60404 2.92166 6.5257 6.5257 6.5257 3.60404 0 6.5257-2.92166 6.5257-6.5257 0-3.60404-2.92166-6.5257-6.5257-6.5257Zm0 3.0039c1.94504 0 3.5218 1.57676 3.5218 3.5218 0 1.94504-1.57676 3.5218-3.5218 3.5218-1.94504 0-3.5218-1.57676-3.5218-3.5218 0-1.94504 1.57676-3.5218 3.5218-3.5218Z",fillColor:"red",fillOpacity:.6,strokeWeight:0,anchor:new google.maps.Point(10,22)})})),e.addListener("dragend",(t=>{const i=new CustomEvent("dragend",{detail:{map:this.map,marker:e,position:{latitude:t.latLng.lat(),longitude:t.latLng.lng()}}});this.dispatchEvent(i)})),e.addListener("click",(()=>{this.loadDetail(e)})),e}generateDetail(){const t=document.createElement("div"),e=document.createElement("div"),i=document.createElement("button");i.setAttribute("type","button"),i.className="gl-map__detail-close",i.innerHTML="&times;",i.addEventListener("click",this.closeDetail.bind(this),!1),e.className="gl-map__detail-content",t.className="gl-map__detail",t.appendChild(e),t.appendChild(i),this.elem.appendChild(t),this.detailElem=t,this.detailContentElem=e}loadDetail(t){const e=this.markerElems.find((e=>e.id===t.id)),i=e?[...e.children]:[];for(this.elem.classList.remove("has-detail"),this.detailElem||this.generateDetail();this.detailContentElem.firstChild;)this.detailContentElem.removeChild(this.detailContentElem.lastChild),console.log("removing child");i.forEach((t=>{this.detailContentElem.appendChild(t.cloneNode(!0))})),this.elem.classList.add("has-detail")}closeDetail(){this.elem.classList.remove("has-detail")}loadGoogleMapsApi(){const t=document.createElement("script");t.id=`map_script_${this._id}`,t.type="text/javascript",t.src=`https://maps.googleapis.com/maps/api/js?key=${this.key}&callback=${this.apiLoadedCBName}&v=weekly`,t.defer=!0,t.async=!0,window[this.apiLoadedCBName]=this.handleApiLoaded.bind(this),document.head.appendChild(t)}connectedCallback(){this._markerElems=this.querySelectorAll("gl-google-marker")}adoptedCallback(){this._markerElems=this.querySelectorAll("gl-google-marker")}attributeChangedCallback(t,e,i){"key"===t&&i&&(this.key=i,this.removeAttribute("key"),this.loadGoogleMapsApi()),"show-markers"===t&&this.markers.forEach((t=>{"client"===t.type&&t.setVisible(this.isMarkersVisible)})),"show-kml"===t&&this.kmlLayer.setMap(this.isKmlVisible?this.map:null),"show-image"===t&&(this.imageLayer.setMap(this.isImageVisible?this.map:null),this.markers.forEach((t=>{"admin"===t.type&&t.setVisible(this.isImageVisible)})))}}window.customElements.get("gl-google-map")||window.customElements.define("gl-google-map",GlGoogleMap);export{GlGoogleMap};
//# sourceMappingURL=gl-google-map.js.map
